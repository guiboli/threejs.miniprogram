!function(){var e,n;e=this,n=function(e,n,t){"use strict";let o;e.MMDExporter=class{parseVpd(e,r,s){if(!0!==e.isSkinnedMesh)return console.warn("THREE.MMDExporter: parseVpd() requires SkinnedMesh instance."),null;function i(e){Math.abs(e)<1e-6&&(e=0);let n=e.toString();-1===n.indexOf(".")&&(n+="."),n+="000000";const t=n.indexOf(".");return n.slice(0,t)+"."+n.slice(t+1,t+7)}function a(e){const n=[];for(let t=0,o=e.length;t<o;t++)n.push(i(e[t]));return n.join(",")}e.updateMatrixWorld(!0);const u=e.skeleton.bones,l=function(e){const n=e.clone();return n.pose(),n.skeleton.bones}(e),c=new n.Vector3,p=new n.Quaternion,h=new n.Quaternion,d=new n.Matrix4,f=[];f.push("Vocaloid Pose Data file"),f.push(""),f.push((""!==e.name?e.name.replace(/\s/g,"_"):"skin")+".osm;"),f.push(u.length+";"),f.push("");for(let e=0,n=u.length;e<n;e++){const n=u[e],t=l[e];!0===s&&void 0!==n.userData.ik&&void 0!==n.userData.ik.originalMatrix?d.fromArray(n.userData.ik.originalMatrix):d.copy(n.matrix),c.setFromMatrixPosition(d),p.setFromRotationMatrix(d);const o=c.sub(t.position).toArray(),r=h.copy(t.quaternion).conjugate().multiply(p).toArray();o[2]=-o[2],r[0]=-r[0],r[1]=-r[1],f.push("Bone"+e+"{"+n.name),f.push("  "+a(o)+";"),f.push("  "+a(r)+";"),f.push("}"),f.push("")}f.push("");const m=f.join("\n");return!0===r?function(e){if(void 0===o){const e=(new t.MMDParser.CharsetEncoder).s2uTable;o={};const n=Object.keys(e);for(let t=0,r=n.length;t<r;t++){let r=n[t];const s=e[r];r=parseInt(r),o[s]=r}}const n=[];for(let t=0,r=e.length;t<r;t++){const r=e.charCodeAt(t),s=o[r];if(void 0===s)throw new Error("cannot convert charcode 0x"+r.toString(16));s>255?(n.push(s>>8&255),n.push(255&s)):n.push(255&s)}return new Uint8Array(n)}(m):m}},Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("three"),require("../libs/mmdparser.module.js")):"function"==typeof define&&define.amd?define(["exports","three","../libs/mmdparser.module"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e["THREE-STD"]||{},e.THREE,e.THREE)}();
