!function(){var e,t;e=this,t=function(e,t){"use strict";const r=new WeakMap;class o extends t.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig=null,console.warn("THREE.BasisTextureLoader: This loader is deprecated, and will be removed in a future release. Instead, use Basis Universal compression in KTX2 (.ktx2) files with THREE.KTX2Loader.")}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerLimit=e,this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}load(e,o,s,a){const i=new t.FileLoader(this.manager);i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);const n=new t.CompressedTexture;return i.load(e,(e=>{if(r.has(e))return r.get(e).promise.then(o).catch(a);this._createTexture([e]).then((function(e){n.copy(e),n.needsUpdate=!0,o&&o(n)})).catch(a)}),s,a),n}parseInternalAsync(e){const{levels:t}=e,r=new Set;for(let e=0;e<t.length;e++)r.add(t[e].data.buffer);return this._createTexture(Array.from(r),{...e,lowLevel:!0})}_createTexture(e,o={}){let s,a;const i=o;let n=0;for(let t=0;t<e.length;t++)n+=e[t].byteLength;const d=this._allocateWorker(n).then((t=>(s=t,a=this.workerNextTaskID++,new Promise(((t,r)=>{s._callbacks[a]={resolve:t,reject:r},s.postMessage({type:"transcode",id:a,buffers:e,taskConfig:i},e)}))))).then((e=>{const{mipmaps:r,width:o,height:s,format:a}=e,i=new t.CompressedTexture(r,o,s,a,t.UnsignedByteType);return i.minFilter=1===r.length?t.LinearFilter:t.LinearMipmapLinearFilter,i.magFilter=t.LinearFilter,i.generateMipmaps=!1,i.needsUpdate=!0,i}));return d.catch((()=>!0)).then((()=>{s&&a&&(s._taskLoad-=n,delete s._callbacks[a])})),r.set(e[0],{promise:d}),d}_initTranscoder(){if(!this.transcoderPending){const e=new t.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const r=new Promise(((t,r)=>{e.load("basis_transcoder.js",t,void 0,r)})),s=new t.FileLoader(this.manager);s.setPath(this.transcoderPath),s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials);const a=new Promise(((e,t)=>{s.load("basis_transcoder.wasm",e,void 0,t)}));this.transcoderPending=Promise.all([r,a]).then((([e,t])=>{const r=o.BasisWorker.toString(),s=["/* constants */","let _EngineFormat = "+JSON.stringify(o.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(o.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(o.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s])),this.transcoderBinary=t}))}return this.transcoderPending}_allocateWorker(e){return this._initTranscoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskLoad=0,e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:this.transcoderBinary}),e.onmessage=function(t){const r=t.data;switch(r.type){case"transcode":e._callbacks[r.id].resolve(r);break;case"error":e._callbacks[r.id].reject(r);break;default:console.error('THREE.BasisTextureLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const t=this.workerPool[this.workerPool.length-1];return t._taskLoad+=e,t}))}dispose(){for(let e=0;e<this.workerPool.length;e++)this.workerPool[e].terminate();return this.workerPool.length=0,this}}o.BasisFormat={ETC1S:0,UASTC_4x4:1},o.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},o.EngineFormat={RGBAFormat:t.RGBAFormat,RGBA_ASTC_4x4_Format:t.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:t.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:t.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:t.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:t.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:t.RGB_ETC1_Format,RGB_ETC2_Format:t.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:t.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:t.RGB_S3TC_DXT1_Format},o.BasisWorker=function(){let e,t,r;const o=_EngineFormat,s=_TranscoderFormat,a=_BasisFormat;onmessage=function(o){const s=o.data;switch(s.type){case"init":e=s.config,i=s.transcoderBinary,t=new Promise((e=>{r={wasmBinary:i,onRuntimeInitialized:e},BASIS(r)})).then((()=>{r.initializeBasis()}));break;case"transcode":t.then((()=>{try{const{width:e,height:t,hasAlpha:o,mipmaps:i,format:n}=s.taskConfig.lowLevel?function(e){const{basisFormat:t,width:o,height:s,hasAlpha:i}=e,{transcoderFormat:n,engineFormat:d}=c(t,o,s,i),m=r.getBytesPerBlockOrPixel(n);h(r.isFormatSupported(n),"THREE.BasisTextureLoader: Unsupported format.");const p=[];if(t===a.ETC1S){const t=new r.LowLevelETC1SImageTranscoder,{endpointCount:o,endpointsData:s,selectorCount:a,selectorsData:d,tablesData:c}=e.globalData;try{let r;r=t.decodePalettes(o,s,a,d),h(r,"THREE.BasisTextureLoader: decodePalettes() failed."),r=t.decodeTables(c),h(r,"THREE.BasisTextureLoader: decodeTables() failed.");for(let o=0;o<e.levels.length;o++){const s=e.levels[o],a=e.globalData.imageDescs[o],d=T(n,s.width,s.height),c=new Uint8Array(d);r=t.transcodeImage(n,c,d/m,s.data,l(n,s.width),_(n,s.height),s.width,s.height,s.index,a.rgbSliceByteOffset,a.rgbSliceByteLength,a.alphaSliceByteOffset,a.alphaSliceByteLength,a.imageFlags,i,!1,0,0),h(r,"THREE.BasisTextureLoader: transcodeImage() failed for level "+s.index+"."),p.push({data:c,width:s.width,height:s.height})}}finally{t.delete()}}else for(let t=0;t<e.levels.length;t++){const o=e.levels[t],s=T(n,o.width,o.height),a=new Uint8Array(s);h(r.transcodeUASTCImage(n,a,s/m,o.data,l(n,o.width),_(n,o.height),o.width,o.height,o.index,0,o.data.byteLength,0,i,!1,0,0,-1,-1),"THREE.BasisTextureLoader: transcodeUASTCImage() failed for level "+o.index+"."),p.push({data:a,width:o.width,height:o.height})}return{width:o,height:s,hasAlpha:i,mipmaps:p,format:d}}(s.taskConfig):function(e){const t=new r.BasisFile(new Uint8Array(e)),o=t.isUASTC()?a.UASTC_4x4:a.ETC1S,s=t.getImageWidth(0,0),i=t.getImageHeight(0,0),n=t.getNumLevels(0),d=t.getHasAlpha();function h(){t.close(),t.delete()}const{transcoderFormat:l,engineFormat:_}=c(o,s,i,d);if(!s||!i||!n)throw h(),new Error("THREE.BasisTextureLoader:\tInvalid texture");if(!t.startTranscoding())throw h(),new Error("THREE.BasisTextureLoader: .startTranscoding failed");const T=[];for(let e=0;e<n;e++){const r=t.getImageWidth(0,e),o=t.getImageHeight(0,e),s=new Uint8Array(t.getImageTranscodedSizeInBytes(0,e,l));if(!t.transcodeImage(s,0,e,l,0,d))throw h(),new Error("THREE.BasisTextureLoader: .transcodeImage failed.");T.push({data:s,width:r,height:o})}return h(),{width:s,height:i,hasAlpha:d,mipmaps:T,format:_}}(s.buffers[0]),d=[];for(let e=0;e<i.length;++e)d.push(i[e].data.buffer);self.postMessage({type:"transcode",id:s.id,width:e,height:t,hasAlpha:o,mipmaps:i,format:n},d)}catch(e){console.error(e),self.postMessage({type:"error",id:s.id,error:e.message})}}))}var i};const i=[{if:"astcSupported",basisFormat:[a.UASTC_4x4],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[o.RGBA_ASTC_4x4_Format,o.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[o.RGBA_BPTC_Format,o.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[s.BC1,s.BC3],engineFormat:[o.RGB_S3TC_DXT1_Format,o.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[o.RGB_ETC2_Format,o.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC1],engineFormat:[o.RGB_ETC1_Format,o.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[o.RGB_PVRTC_4BPPV1_Format,o.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],n=i.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),d=i.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function c(t,r,i,c){let h,l;const _=t===a.ETC1S?n:d;for(let o=0;o<_.length;o++){const s=_[o];if(e[s.if]&&s.basisFormat.includes(t)&&(!s.needsPowerOfTwo||m(r)&&m(i)))return h=s.transcoderFormat[c?1:0],l=s.engineFormat[c?1:0],{transcoderFormat:h,engineFormat:l}}return console.warn("THREE.BasisTextureLoader: No suitable compressed texture format found. Decoding to RGBA32."),h=s.RGBA32,l=o.RGBAFormat,{transcoderFormat:h,engineFormat:l}}function h(e,t){if(!e)throw new Error(t)}function l(e,t){return Math.ceil(t/r.getFormatBlockWidth(e))}function _(e,t){return Math.ceil(t/r.getFormatBlockHeight(e))}function T(e,t,o){const a=r.getBytesPerBlockOrPixel(e);if(r.formatIsUncompressed(e))return t*o*a;if(e===s.PVRTC1_4_RGB||e===s.PVRTC1_4_RGBA){const e=t+3&-4,r=o+3&-4;return(Math.max(8,e)*Math.max(8,r)*4+7)/8}return l(e,t)*_(e,o)*a}function m(e){return e<=2||0==(e&e-1)&&0!==e}},e.BasisTextureLoader=o,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e["THREE-STD"]||{},e.THREE)}();
