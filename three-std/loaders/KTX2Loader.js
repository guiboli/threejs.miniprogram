!function(){var e,r;e=this,r=function(e,r,t){"use strict";const o=new WeakMap;let s=0;class n extends r.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new t.WorkerPool,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},e.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this}init(){if(!this.transcoderPending){const e=new r.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),o=new r.FileLoader(this.manager);o.setPath(this.transcoderPath),o.setResponseType("arraybuffer"),o.setWithCredentials(this.withCredentials);const a=o.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,a]).then((([e,r])=>{const t=n.BasisWorker.toString(),o=["/* constants */","let _EngineFormat = "+JSON.stringify(n.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(n.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(n.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",t.substring(t.indexOf("{")+1,t.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([o])),this.transcoderBinary=r,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),r=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:r},[r]),e}))})),s>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),s++}return this.transcoderPending}load(e,t,s,n){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const a=new r.FileLoader(this.manager);a.setResponseType("arraybuffer"),a.setWithCredentials(this.withCredentials);const i=new r.CompressedTexture;return a.load(e,(e=>{if(o.has(e))return o.get(e).promise.then(t).catch(n);this._createTexture([e]).then((function(e){i.copy(e),i.needsUpdate=!0,t&&t(i)})).catch(n)}),s,n),i}_createTextureFrom(e){const{mipmaps:t,width:o,height:s,format:n,type:a,error:i,dfdTransferFn:d,dfdFlags:c}=e;if("error"===a)return Promise.reject(i);const _=new r.CompressedTexture(t,o,s,n,r.UnsignedByteType);return _.minFilter=1===t.length?r.LinearFilter:r.LinearMipmapLinearFilter,_.magFilter=r.LinearFilter,_.generateMipmaps=!1,_.needsUpdate=!0,_.encoding=2===d?r.sRGBEncoding:r.LinearEncoding,_.premultiplyAlpha=!!(1&c),_}_createTexture(e,r={}){const t=r,s=this.init().then((()=>this.workerPool.postMessage({type:"transcode",buffers:e,taskConfig:t},e))).then((e=>this._createTextureFrom(e.data)));return o.set(e[0],{promise:s}),s}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),s--,this}}n.BasisFormat={ETC1S:0,UASTC_4x4:1},n.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},n.EngineFormat={RGBAFormat:r.RGBAFormat,RGBA_ASTC_4x4_Format:r.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:r.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:r.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:r.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:r.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:r.RGB_ETC1_Format,RGB_ETC2_Format:r.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:r.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:r.RGB_S3TC_DXT1_Format},n.BasisWorker=function(){let e,r,t;const o=_EngineFormat,s=_TranscoderFormat,n=_BasisFormat;self.addEventListener("message",(function(a){const _=a.data;switch(_.type){case"init":e=_.config,T=_.transcoderBinary,r=new Promise((e=>{t={wasmBinary:T,onRuntimeInitialized:e},BASIS(t)})).then((()=>{t.initializeBasis(),void 0===t.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")}));break;case"transcode":r.then((()=>{try{const{width:r,height:a,hasAlpha:T,mipmaps:p,format:m,dfdTransferFn:h,dfdFlags:l}=function(r){const a=new t.KTX2File(new Uint8Array(r));function _(){a.close(),a.delete()}if(!a.isValid())throw _(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");const T=a.isUASTC()?n.UASTC_4x4:n.ETC1S,p=a.getWidth(),m=a.getHeight(),h=a.getLevels(),l=a.getHasAlpha(),C=a.getDFDTransferFunc(),u=a.getDFDFlags(),{transcoderFormat:f,engineFormat:F}=function(r,t,a,_){let T,p;const m=r===n.ETC1S?i:d;for(let o=0;o<m.length;o++){const s=m[o];if(e[s.if]&&s.basisFormat.includes(r)&&!(_&&s.transcoderFormat.length<2)&&(!s.needsPowerOfTwo||c(t)&&c(a)))return T=s.transcoderFormat[_?1:0],p=s.engineFormat[_?1:0],{transcoderFormat:T,engineFormat:p}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),T=s.RGBA32,p=o.RGBAFormat,{transcoderFormat:T,engineFormat:p}}(T,p,m,l);if(!p||!m||!h)throw _(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!a.startTranscoding())throw _(),new Error("THREE.KTX2Loader: .startTranscoding failed");const B=[];for(let e=0;e<h;e++){const r=a.getImageLevelInfo(e,0,0),t=r.origWidth,o=r.origHeight,s=new Uint8Array(a.getImageTranscodedSizeInBytes(e,0,0,f));if(!a.transcodeImage(s,e,0,0,f,0,-1,-1))throw _(),new Error("THREE.KTX2Loader: .transcodeImage failed.");B.push({data:s,width:t,height:o})}return _(),{width:p,height:m,hasAlpha:l,mipmaps:B,format:F,dfdTransferFn:C,dfdFlags:u}}(_.buffers[0]),C=[];for(let e=0;e<p.length;++e)C.push(p[e].data.buffer);self.postMessage({type:"transcode",id:_.id,width:r,height:a,hasAlpha:T,mipmaps:p,format:m,dfdTransferFn:h,dfdFlags:l},C)}catch(e){console.error(e),self.postMessage({type:"error",id:_.id,error:e.message})}}))}var T}));const a=[{if:"astcSupported",basisFormat:[n.UASTC_4x4],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[o.RGBA_ASTC_4x4_Format,o.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[o.RGBA_BPTC_Format,o.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.BC1,s.BC3],engineFormat:[o.RGB_S3TC_DXT1_Format,o.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[o.RGB_ETC2_Format,o.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.ETC1],engineFormat:[o.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[o.RGB_PVRTC_4BPPV1_Format,o.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],i=a.sort((function(e,r){return e.priorityETC1S-r.priorityETC1S})),d=a.sort((function(e,r){return e.priorityUASTC-r.priorityUASTC}));function c(e){return e<=2||0==(e&e-1)&&0!==e}},e.KTX2Loader=n,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("three"),require("../utils/WorkerPool.js")):"function"==typeof define&&define.amd?define(["exports","three","../utils/WorkerPool"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e["THREE-STD"]||{},e.THREE,e.THREE)}();
