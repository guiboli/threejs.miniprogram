!function(){var e,t;e=this,t=function(e,t){"use strict";const r=new t.Quaternion,i=new t.Vector3,o=new t.Vector3,n=new t.Vector3,s=new t.Vector3,a=new t.Vector3,l=new t.Quaternion,h=new t.Vector3,c=new t.Vector3,d=new t.Vector3,p=new t.Matrix4;function m(e,t){return d.setFromMatrixPosition(e.matrixWorld).applyMatrix4(t)}function u(e,t,r,i){const o=m(r,i);e[3*t+0]=o.x,e[3*t+1]=o.y,e[3*t+2]=o.z}class f extends t.Object3D{constructor(e,r=[]){super(),this.root=e,this.iks=r,this.matrix.copy(e.matrixWorld),this.matrixAutoUpdate=!1,this.sphereGeometry=new t.SphereGeometry(.25,16,8),this.targetSphereMaterial=new t.MeshBasicMaterial({color:new t.Color(16746632),depthTest:!1,depthWrite:!1,transparent:!0}),this.effectorSphereMaterial=new t.MeshBasicMaterial({color:new t.Color(8978312),depthTest:!1,depthWrite:!1,transparent:!0}),this.linkSphereMaterial=new t.MeshBasicMaterial({color:new t.Color(8947967),depthTest:!1,depthWrite:!1,transparent:!0}),this.lineMaterial=new t.LineBasicMaterial({color:new t.Color(16711680),depthTest:!1,depthWrite:!1,transparent:!0}),this._init()}updateMatrixWorld(e){const t=this.root;if(this.visible){let e=0;const r=this.iks,i=t.skeleton.bones;p.copy(t.matrixWorld).invert();for(let t=0,o=r.length;t<o;t++){const o=r[t],n=i[o.target],s=i[o.effector],a=this.children[e++],l=this.children[e++];a.position.copy(m(n,p)),l.position.copy(m(s,p));for(let t=0,r=o.links.length;t<r;t++){const r=i[o.links[t].index];this.children[e++].position.copy(m(r,p))}const h=this.children[e++],c=h.geometry.attributes.position.array;u(c,0,n,p),u(c,1,s,p);for(let e=0,t=o.links.length;e<t;e++)u(c,e+2,i[o.links[e].index],p);h.geometry.attributes.position.needsUpdate=!0}}this.matrix.copy(t.matrixWorld),super.updateMatrixWorld(e)}_init(){const e=this,r=this.iks;function i(r){return new t.Line(function(e){const r=new t.BufferGeometry,i=new Float32Array(3*(2+e.links.length));return r.setAttribute("position",new t.BufferAttribute(i,3)),r}(r),e.lineMaterial)}for(let o=0,n=r.length;o<n;o++){const n=r[o];this.add(new t.Mesh(e.sphereGeometry,e.targetSphereMaterial)),this.add(new t.Mesh(e.sphereGeometry,e.effectorSphereMaterial));for(let r=0,i=n.links.length;r<i;r++)this.add(new t.Mesh(e.sphereGeometry,e.linkSphereMaterial));this.add(i(n))}}}e.CCDIKHelper=f,e.CCDIKSolver=class{constructor(e,t=[]){this.mesh=e,this.iks=t,this._valid()}update(){const e=this.iks;for(let t=0,r=e.length;t<r;t++)this.updateOne(e[t]);return this}updateOne(e){const t=this.mesh.skeleton.bones,p=Math,m=t[e.effector],u=t[e.target];i.setFromMatrixPosition(u.matrixWorld);const f=e.links,x=void 0!==e.iteration?e.iteration:1;for(let u=0;u<x;u++){let u=!1;for(let x=0,M=f.length;x<M;x++){const M=t[f[x].index];if(!1===f[x].enabled)break;const w=f[x].limitation,y=f[x].rotationMin,g=f[x].rotationMax;M.matrixWorld.decompose(a,l,h),l.invert(),n.setFromMatrixPosition(m.matrixWorld),s.subVectors(n,a),s.applyQuaternion(l),s.normalize(),o.subVectors(i,a),o.applyQuaternion(l),o.normalize();let k=o.dot(s);if(k>1?k=1:k<-1&&(k=-1),k=p.acos(k),!(k<1e-5)){if(void 0!==e.minAngle&&k<e.minAngle&&(k=e.minAngle),void 0!==e.maxAngle&&k>e.maxAngle&&(k=e.maxAngle),c.crossVectors(s,o),c.normalize(),r.setFromAxisAngle(c,k),M.quaternion.multiply(r),void 0!==w){let e=M.quaternion.w;e>1&&(e=1);const t=p.sqrt(1-e*e);M.quaternion.set(w.x*t,w.y*t,w.z*t,e)}void 0!==y&&M.rotation.setFromVector3(d.setFromEuler(M.rotation).max(y)),void 0!==g&&M.rotation.setFromVector3(d.setFromEuler(M.rotation).min(g)),M.updateMatrixWorld(!0),u=!0}}if(!u)break}return this}createHelper(){return new f(this.mesh,this.mesh.geometry.userData.MMD.iks)}_valid(){const e=this.iks,t=this.mesh.skeleton.bones;for(let r=0,i=e.length;r<i;r++){const i=e[r],o=t[i.effector],n=i.links;let s,a;s=o;for(let e=0,r=n.length;e<r;e++)a=t[n[e].index],s.parent!==a&&console.warn("THREE.CCDIKSolver: bone "+s.name+" is not the child of bone "+a.name),s=a}}},Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e["THREE-STD"]||{},e.THREE)}();
